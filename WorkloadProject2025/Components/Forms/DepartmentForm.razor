@using System.ComponentModel.DataAnnotations
@using WorkloadProject2025.Data.Models
@inject DepartmentService departmentService

<MudDialog>
    <DialogContent>
        <EditForm Model="department" OnValidSubmit="Save">
            <DataAnnotationsValidator />
            <MudStack Spacing="2">
                <MudStaticTextField For="@(() => department.Name)"
                                    @bind-Value="department.Name"
                                    Label="Department Name"
                                    Required="true"
                                    Adornment="Adornment.Start"
                                    AdornmentIcon="@Icons.Material.Filled.Business"/>

                <MudSelect For="@(() => department.SchoolId)"
                           @bind-value="department.SchoolId"
                           Label="School"
                           T="int?"
                           Required="true"
                           Immediate="true"
                           Adornment="Adornment.Start"
                           AdornmentIcon="@Icons.Material.Filled.School">
                    <MudSelectItem T="int?" Value="@(null)">Select a School</MudSelectItem>

                    @foreach (School school in Schools)
                    {
                        <MudSelectItem T="int?" Value="@school.Id">@school.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudStack>
            <MudCardActions Class="d-flex justify-end mt-4">
                <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="Cancel">Cancel</MudButton>
                <MudStaticButton Variant="Variant.Text" Color="Color.Secondary" FormAction="FormAction.Submit">Save</MudStaticButton>
            </MudCardActions>
        </EditForm>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = default!;
    
    [Parameter]
    public EventCallback OnSaved { get; set; }

    [Parameter]
    public List<School> Schools { get; set; } = new();

    private Department department { get; set; } = new Department();

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task Save()
    {
        await departmentService.AddAsync(department);
        await OnSaved.InvokeAsync();
        department = new Department();
        MudDialog.Close(DialogResult.Ok(true));
        StateHasChanged();
    }
}
