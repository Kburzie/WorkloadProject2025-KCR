@page "/CoursePage"
@using WorkloadProject2025.Data.Models
@using WorkloadProject2025.Services
@inject CourseService courseService
@inject ProgramsOfStudyService programsOfStudyService
@inject IDialogService DialogService

<MudCard Class="mx-auto mt-6" Style="max-width: 850px;">
    <MudCardHeader>
        <MudText Typo="Typo.h5" Class="font-semibold">Current Courses</MudText>
        <MudSpacer />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Style="text-transform: uppercase;" OnClick="OpenAddCourseDialog">Add New Course</MudButton>
    </MudCardHeader>

    <MudCardContent>
        <MudTable Items="@courses" Hover="true" Breakpoint="Breakpoint.Sm">
            <HeaderContent>
                <MudTh>Course</MudTh>
                <MudTh>Program</MudTh>
                <MudTh>Hours</MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Course">@context.Name</MudTd>
                <MudTd DataLabel="Program">@context.ProgramOfStudy?.Name</MudTd>
                <MudTd DataLabel="Hours">@context.Hours</MudTd>
                <MudTd DataLabel="">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Error" 
                               Size="Size.Small"
                               OnClick="@(async () => await DeleteCourse(context.Id, context.Name))">
                        Delete
                    </MudButton>
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudCardContent>
</MudCard>

@code {
    List<Course> courses = new();
    List<ProgramOfStudy> programsOfStudy = new();

    protected override async Task OnInitializedAsync()
    {
        courses = await courseService.GetAllAsync();
        programsOfStudy = await programsOfStudyService.GetAllAsync();
    }

    private async Task OpenAddCourseDialog()
    {
        var parameters = new DialogParameters<CoursesForm>
        {
            { x => x.programOfStudy, programsOfStudy }
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CoursesForm>("Add New Course", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await Save();
        }
    }

    public async Task Save()
    {
        courses = await courseService.GetAllAsync();
        StateHasChanged();
    }

    private async Task DeleteCourse(int id, string name)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to delete the course '{name}'? This action cannot be undone.",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                await courseService.DeleteAsync(id);
                courses = await courseService.GetAllAsync();
                StateHasChanged();
            }
            catch (Exception ex)
            {
                await DialogService.ShowMessageBox("Error", $"Failed to delete course: {ex.Message}");
            }
        }
    }
}